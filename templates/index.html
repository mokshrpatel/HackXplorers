<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Financial Crime Compliance Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }

    .card {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Scrollable Transactions Section */
    .scrollable-table {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    /* Sticky Header for Transactions */
    .scrollable-table thead {
      position: sticky;
      top: 0;
      background-color: white;
      z-index: 1;
    }

    /* Top Bar Styling */
    .top-bar {
      position: relative;
      background-color: #0d6efd; /* Original top bar color */
      color: white;
      padding: 15px;
      text-align: center;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .top-bar h2 {
      margin: 0;
      font-size: 24px;
      font-weight: bold;
    }

    /* Logout Button Styling */
    .logout-button {
      position: absolute;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
    }

    .logout-button .btn {
      background-color: #dc3545; /* Red color */
      border: none;
      border-radius: 8px; /* Rounded edges */
      padding: 8px 16px;
      font-size: 14px;
      font-weight: bold;
      color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow */
      transition: background-color 0.3s ease;
    }

    .logout-button .btn:hover {
      background-color: #c82333; /* Darker red on hover */
    }
    /* Heatmap Container */
    #heatmap {
      width: 100%;
      height: 200px;
      position: relative;
    }
  </style>
</head>

<body>
  <div class="container-fluid p-4">
    <!-- Top Bar with Logout Button -->
    <div class="top-bar">
      <h2>Financial Crime Compliance Dashboard</h2>
      <div class="logout-button">
        <a href="/logout" class="btn">Logout</a>
      </div>
    </div>

    <div class="row mt-4">
      <!-- Transactions -->
      <div class="col-md-4 mb-4">
        <div class="card p-3">
          <h5>Transactions</h5>
          <input type="text" class="form-control mb-2" placeholder="Filter transactions...">

          <!-- Scrollable Section -->
          <div class="scrollable-table">
            <table class="table table-bordered table-sm">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Description</th>
                  <th>Risk</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="transaction-table-body">
                {% for row in rows %}
                <tr>
                  <td>{{row['transaction_id']}}</td>
                  <td>{{row['date']}}</td>
                  <td>{{row['amount']}}</td>
                  <td>{{row['description']}}</td>
                  <td>{{row['risk']}}</td>
                  <td>{{row['status']}}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <!-- End Scrollable Section -->

        </div>
      </div>

      <!-- Add Transaction -->
      <div class="col-md-4 mb-4">
        <div class="card p-3">
          <h5>Add Transaction</h5>
          <input type="text" class="form-control mb-2" placeholder="Transaction ID (e.g., TX2000)">
          <input type="date" class="form-control mb-2">
          <input type="number" class="form-control mb-2" placeholder="Amount">
          <input type="text" class="form-control mb-2" placeholder="Description">
          <select class="form-control mb-2">
            <option>Low</option>
            <option>Medium</option>
            <option>High</option>
          </select>
          <select class="form-control mb-3">
            <option>Approved</option>
            <option>Pending</option>
            <option>Rejected</option>
          </select>
          <button class="btn btn-primary w-100">Add Transaction</button>
        </div>
      </div>

      <!-- Heatmap -->
      <div class="col-md-4 mb-4">
        <div class="card p-3">
          <h5>Risk Heatmap</h5>
          <div id="heatmap">
            <canvas id="riskHeatmap"></canvas> <!-- Canvas for Chart.js -->
          </div>
          <button class="btn btn-primary mt-3" onclick="updateHeatmap()">Generate Heatmap</button>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Audit Deadlines -->
      <div class="col-md-6 mb-4">
        <div class="card p-3">
          <h5>Audit Deadlines Calendar</h5>
          <div class="d-flex mb-2">
            <input type="date" class="form-control me-2">
            <input type="text" class="form-control me-2" placeholder="Deadline Description">
            <select class="form-control me-2">
              <option>Open</option>
              <option>Closed</option>
            </select>
            <button class="btn btn-primary">Add Deadline</button>
          </div>
          <!-- Calendar/Deadlines will be shown here -->
        </div>
      </div>

      <!-- Chartio Dashboard -->
      <div class="col-md-6 mb-4">
        <div class="card p-3">
          <h5>Interactive Dashboard (Chartio)</h5>
          <div style="height: 250px; overflow: auto;">
            <p class="text-danger fw-bold">Not Found</p>
            <p>The requested URL was not found on the server. Please check your spelling and try again.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

{% include 'chatbot.html' %}
<script>
  // Initialize Chart.js
  let riskHeatmapChart;

  // Function to fetch risk data and update the heatmap
  function updateHeatmap() {
    console.log("Fetching risk data..."); // Debugging
    fetch("/api/risk-data")
      .then(response => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then(data => {
        console.log("Risk data received:", data); // Debugging
        const ctx = document.getElementById('riskHeatmap').getContext('2d');

        // Destroy existing chart if it exists
        if (riskHeatmapChart) {
          riskHeatmapChart.destroy();
        }

        // Create new chart
        riskHeatmapChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['High', 'Medium', 'Low'],
            datasets: [{
              label: 'Risk Distribution',
              data: [data.high, data.medium, data.low],
              backgroundColor: [
                '#ff4d4d', // High risk color
                '#ffa64d', // Medium risk color
                '#4dff4d', // Low risk color
              ],
              borderWidth: 1,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
              },
              tooltip: {
                enabled: true,
              }
            }
          }
        });
      })
      .catch(error => {
        console.error("Error fetching risk data:", error); // Debugging
      });
  }

  // Initial heatmap load
  updateHeatmap();
</script>

</body>

</html>
